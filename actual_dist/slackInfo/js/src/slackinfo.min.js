/*! slackinfo 02-11-2015 */
function loadTemplates(a){var b=[];return $.each(a,function(a,c){var d=c+"View";app[d]?b.push($.get(app.templates.path+c+".html",function(a){app[d].prototype.template=_.template(a)})):console.log(c+" not found")}),$.when.apply(null,b)}function autoSizeText(){var a,b,c,d,e;if(b=$(".resize"),console.log(b),!(b.length<0)){for(e=[],c=0,d=b.length;d>c;c++)console.log("resizeing something"),a=b[c],e.push(function(a){var b,c;for(b=function(){var b;return b=parseInt($(a).css("font-size").slice(0,-2))-1+"px",$(a).css("font-size",b)},c=[];a.scrollHeight>a.offsetHeight;)c.push(b());return c}(a));return e}}function createTextFills(a,b){var c,d=_.extend({},b);$("."+a).textfill(d),$(window).on("resize",function(b){clearTimeout(c),c=setTimeout(function(){$("."+a).textfill(d)},250)})}function makeDatePretty(a){var b=new Date(a),c=b.getUTCMonth()+1,d=b.getUTCDate(),e=b.getUTCFullYear();return c+"/"+d+"/"+e}function _removeDupeTags(a){var b=a,c=[],d=!1;if(_.each(a,function(a,e,f){a.split(" ").length>1&&_.each(b,function(b,f,g){a==b||-1==a.indexOf(b)&&-1==b.indexOf(a)||(d=!0,c.push({word:a,index:e}),c.push({word:b,index:f}))})}),!d)return b;var e="asdasdasdasdasasdasdasdasdasdasdasdasdasdasdasdasdasdasdasdasdasdasd",f=-1;_.each(c,function(a,b,c){a.word.length<e.length&&(e=a.word,f=a.index)});var g=_.uniq(_.pluck(_.reject(c,function(a){return a.word===e}),"index"));return _.each(g,function(a,c,d){b.splice(a,1)}),b}var app=app||{};$(document).ready(function(){function a(){console.log("Init function! "),app.searchService,app.songList.searchService=new app.SearchService("js/lib/fuse.min.js",app.songList,["artist","contributor","service","tags","title"],{threshold:.2,useModels:!0}),app.mainView=new app.MainView,app.controlsModel.sortTags(),app.switchView=(new app.SwitchView).render(),componentHandler.upgradeDom(),createTextFills("resize"),app.router=new app.Router,Backbone.history.start()}app.songList=new app.SongList,app.controlsModel=new app.ControlsModel,$.when(loadTemplates(app.templates.names),app.controlsModel.getFromServer("users"),app.controlsModel.getFromServer("count"),app.controlsModel.getFromServer("tallies"),app.songList.fetch()).then(function(b,c,d,e,f){_.each(e[0],function(a,b,c){app.controlsModel.set(b,a)}),console.log("comparing ",f.length,d[0]),f.length===d[0]?(console.log("no change bruh"),a()):(console.log("we got some CHANGES change bruh"),app.songList.burnItDown(),app.songList.fetchFromServer().then(a))})}),app.ControlsModel=Backbone.Model.extend({defaults:{currSongList:[],filterList:["tags","contributors","services"],users:[],serverRoutes:{users:"users",count:"count",tallies:"tallies",collection:"collection"},switchRefObj:{}},initialize:function(){return this},getFromServer:function(a){var b=this;return $.getJSON(app.config.serverURL+this.get("serverRoutes")[a]).done(function(c){console.log("GOT stuff",c),b.set(a,c)}).fail(function(b){console.log("failed fetching",a)})},sortTags:function(){var a=this;_.each(a.get("filterList"),function(b,c,d){a.attributes[b+"Sorted"]=_.sortBy(_.toArray(a.get(b)),"count").reverse()})},addToTally:function(a,b){var c=this.get(a),d=c?c:this.attributes[a]={};return d[b]?d[b].count++:this.attributes[a][b]={name:b,count:1},d}}),app.Song=Backbone.Model.extend({defaults:{title:"",artist:"",artist_info:{},tags:[],url:"",contributor:"",service:"",thumbnail:"",description:""},initialize:function(a){return this.set("attributes",a),this}}),app.SongList=Backbone.Collection.extend({model:app.Song,url:"/api/songs",SONG_URL:"app/exports/1.json",COUNT_URL:"/count",localStorage:new Backbone.LocalStorage("local-songs"),comparator:"title",searchService:{},initialize:function(){return this},filterBy:function(a){return this.filter(function(b){return b.get("service")===a})},basicSearch:function(a){console.log("searching for: "+a);var b=new RegExp(a,"gi");return console.log(this),this.filter(function(a){return b.test(a.get("title"))})},fuzzySearch:function(a){return this.searchService.search(a)},burnItDown:function(){_.chain(this.models).clone().each(function(a){a.destroy()})},fetchFromServer:function(){var a=this;return $.getJSON(app.config.serverURL+"collection").done(function(b){console.log("GOT stuff"),console.log(b),_.each(b.models,function(b,c,d){var e=new app.Song(b);a.add(e),e.save()})}).fail(function(a){console.log("failed fetching")})}}),app.Router=Backbone.Router.extend({routes:{"*filter":"setFilter"},setFilter:function(a){a&&(console.log("app.router.params = "+a),window.filter=a.trim()||"",app.todoList.trigger("reset"))}}),app.SearchService=function(){function a(a,b){return-1!=a.indexOf(b)?a:!1}function b(a){return $.getScript(a).done(function(a,b){}).fail(function(a,b,c){console.log("failed to load search script")})}var c=function(c,d,e,f){this.libName="",this.searchObj={};var g=this;if(this.useModels=!1,f.useModels){this.fullArr=_.pluck(d.models,"attributes"),this.modelArr=d.models,this.useModels=!0;for(var h=0;h<this.fullArr.length;h++)this.fullArr[h].index=h}else this.fullArr=d;switch(c){case a(c,"fuse"):this.libName="fuse",this.options=f||{caseSensitive:!1,includeScore:!1,shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:32},this.options.keys=e,b(c).then(function(){g.searchObj=new Fuse(g.fullArr,g.options)});break;case a(c,"lunr"):console.log("LUNR TIME"),this.libName="lunr",b(c).then(function(){g.searchObj=lunr(function(){for(var a=0;a<e.length;a++)this.field(e[a]);this.ref("id")});for(var a=0;a<d.length;a++)d[a].id=a,g.searchObj.add(d[a])});break;default:throw console.log("library not supported yet"),"error"}};return c.prototype.search=function(a){var b=[];switch(this.libName){case"fuse":b=this.searchObj.search(a);break;case"lunr":for(var c=this.searchObj.search(a),d=0;d<c.length;d++)b.push(this.fullArr[c[d].ref]);break;default:throw console.log("library not supported yet"),"error"}if(this.useModels){for(var e=[],d=0;d<b.length;d++)e.push(this.modelArr[b[d].index]);b=e}return b},c}();var serviceArr=["soundcloud","youtube","hypem","spotify"];String.prototype.hasUrl=function(){return new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/.*)?").test(this)},String.prototype.matchesService=function(){var a=this,b=!1;return _.each(serviceArr,function(c,d,e){return-1!==a.indexOf(c)?(b=!0,!0):void 0}),b},String.prototype.sdbm_hash=function(){var a=0;for(i=0;i<this.length;i++){var b=this.charCodeAt(i);a=b+(a<<6)+(a<<16)-a}return a},Date.prototype.toPrettyString=function(){var a=this.getUTCMonth()+1,b=this.getUTCDate(),c=this.getUTCFullYear();return a+"/"+b+"/"+c},app.MainView=Backbone.View.extend({el:"#songapp",songMatcher:_.matcher({title:!0}),initialize:function(){var a=this;return $(document).bind("keypress",function(b){a.shortcutKeys(b)}),this.render(),app.songListView,this.songListView=new app.SongListView({collection:app.songList}).renderChunk(),app.headerView,this.headerView=(new app.HeaderView).render(),this},headerView:{},songListView:{},switchView:{},render:function(){return this.$el.append(this.template()),this},spawnCard:function(a){return $(".card-holder").empty().append(a.$el),this},shortcutKeys:function(a){if("INPUT"!=$(a.currentTarget.activeElement)[0].nodeName){var b=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});switch(a.keyCode){case 102:var c=$("#search-btn")[0];c.dispatchEvent(b),setTimeout(function(){$("#search").val("")},20);break;case 116:var c=$("#switch-tags")[0];c.dispatchEvent(b),app.controlsModel.trigger("rowToggle","tags");break;case 99:var c=$("#switch-contributors")[0];c.dispatchEvent(b),app.controlsModel.trigger("rowToggle","contributors");break;case 115:var c=$("#switch-services")[0];c.dispatchEvent(b),app.controlsModel.trigger("rowToggle","services");break;default:console.log("none of those keys",a.keyCode)}}return this},events:{"keyup document":"shortcutKeys"}}),app.SongView=Backbone.View.extend({tagName:"div",render:function(){var a=this.template(this.model.toJSON());return this.$el.html(a),this},initialize:function(){var a=new Date(Number(this.model.get("date")));return this.model.set("prettyDate",makeDatePretty(a)),this},showSongCard:function(a){console.log("showSongCard",this.model.id),$("#"+this.model.id).slideToggle()},songChanged:function(a){},events:{"click .song":"showSongCard"}}),app.SongListView=Backbone.View.extend({el:".song-list",numRendered:0,chunk:10,spinner:'<div class="spinner-holder"><div class="mdl-spinner mdl-js-spinner is-active spinner"></div></div>',initialize:function(){app.controlsModel.set({currSongList:this.collection.models});var a=this;return this.listenTo(app.controlsModel,"change:currSongList",function(b){console.log("triggering herez"),a.numRendered=0,a.renderList(b.get("currSongList"))}),this.infiniteScroll(),this},render:function(){return console.log("RENDERING songlist"),this.$el.empty(),this.collection.each(this.addOne,this),createTextFills("song-text",{minFontPixels:15,maxFontPixels:23}),this},renderChunk:function(){console.log("rendner chunk, starting at",this.numRendered);for(var a=0;a<this.chunk;a++)app.controlsModel.get("currSongList")[this.numRendered]&&(this.addOne(app.controlsModel.get("currSongList")[this.numRendered]),this.numRendered++);return createTextFills("song-text",{minFontPixels:15,maxFontPixels:23}),this},renderList:function(a){console.log("renderList"),this.$el.empty();return this.renderChunk(),this},addOne:function(a){var b=new app.SongView({model:a});this.$el.append(b.render().el)},infiniteScroll:function(){var a=this;this.$el.scroll(_.throttle(function(b){var c=$(b.currentTarget);c[0].scrollHeight-c.scrollTop()<=c.outerHeight()&&(console.log("hit bottom",app.songList.models.length,a.numRendered),a.numRendered<app.controlsModel.get("currSongList").length&&(console.log("REACHED BOTTOM, CALLING"),a.renderChunk(),a.$el.append(a.spinner),componentHandler.upgradeDom(),setTimeout(function(){$(".spinner-holder").remove(".spinner-holder")},1500)))},500))},events:{"scroll .song-list":"infiniteScroll"}}),app.SongCardView=Backbone.View.extend({tagName:"div",render:function(){return this.$el.html(this.template(this.model.toJSON())),console.log(this.model.toJSON()),this.$el.attr("id","song-card-"+this.id),this.$(".mdl-card__media").css("background-color",randomColor({luminosity:"dark"})),this},initialize:function(){this.id=this.model.cid}}),app.HeaderView=Backbone.View.extend({el:"#controls",searchField:{},fromKeyboard:!1,render:function(){var a=this;return this.$el.html(this.template()),this.searchField=$("#search"),this.listenTo(app.controlsModel,"click-filterBtn",function(b){$(".mdl-textfield--expandable").addClass("is-focused"),$(".mdl-textfield__input").val(b),a._searchFor(b)}),this},initialize:function(){},searchChanged:function(a){if(console.log(this.fromKeyboard),this.fromKeyboard)this.fromKeyboard=!1;else{var b=$(a.target).val();this._searchFor(b),app.controlsModel.trigger("searchFor",b)}},_searchFor:function(a){var b=app.controlsModel.get("currSongList");if(a.length<=2)app.controlsModel.set({currSongList:app.songList.models});else if(a.length>2){var c=app.songList.fuzzySearch(a);_.each(c,function(a,b,c){a.cid="NA"}),_.isEqual(c,b)||app.controlsModel.set({currSongList:c})}},events:{"click #search-btn":function(a){console.log("asdasz"),0==a.clientX&&(this.fromKeyboard=!0)},"keyup .search-field":"searchChanged"}}),app.SwitchView=Backbone.View.extend({el:".switch-box",switchRefObj:{},render:function(){return this.$el.append(this.template(this.switchRefObj)),this},initialize:function(a){var b=this;return console.log(app.controlsModel.get("filterList")),_.each(app.controlsModel.get("filterList"),function(a,c,d){b.switchRefObj[a]={name:a,isOn:!1,topBtns:app.controlsModel.attributes[a+"Sorted"].slice(0,12)}}),app.controlsModel.set({switchRefObj:this.switchRefObj}),this.listenTo(app.controlsModel,"rowToggle",this.toggleBtnRow),this.listenTo(app.controlsModel,"searchFor",this.findBtnBySearch),this},toggleBtnRow:function(a){var b=$("#"+a+"-btnRow");this.switchRefObj[a].btnRow?b.slideToggle():this.switchRefObj[a].btnRow=new app.BtnRowView(_.pluck(this.switchRefObj[a].topBtns,"name"),a).render()},btnRowChange:function(a,b){if(0!=a.clientX){var c=a.target.id;this.switchRefObj[c].isOn=!this.switchRefObj[c].isOn,app.controlsModel.trigger("rowToggle",c)}},findBtnBySearch:function(a){$(".btn-toggledOn").removeClass("btn-toggledOn"),_.each(this.switchRefObj,function(b,c,d){b.btnRow&&b.btnRow.$el.find("span").filter(function(){return $(this).text()==a}).parent().addClass("btn-toggledOn")})},stopIt:function(a,b){a.stopPropagation()},events:{"click .mdl-switch":"btnRowChange","click .resize,.capitalize,.mdl-switch__track,.mdl-switch__thumb,.mdl-switch__ripple-container":"stopIt"}}),app.BtnRowView=Backbone.View.extend({el:".btn-box",topBtns:[],btnWidth:1,rowId:"",render:function(){return console.log("rendering buttn row",this.btnWidth),this.$el.append(this.template(this.topBtns)),$("#"+this.rowId+"-btnRow").slideToggle(),createTextFills("filter-btn",{minFontPixels:10}),this},initialize:function(a,b){return this.topBtns=a,this.rowId=b,this.btnWidth=12/a.length<2?1:Math.floor(12/a.length),this},filterBtnClick:function(a){event.stopPropagation();var b=$(a.target).attr("data"),c="span"==a.target.localName?a.target.parentNode:a.target;$(".btn-toggledOn").removeClass("btn-toggledOn"),$(c).addClass("btn-toggledOn"),app.controlsModel.trigger("click-filterBtn",b)},events:{"click .mdl-button":"filterBtnClick"}});